# IP协议
IP协议是网络层的协议，是TCP/IP协议簇的核心协议。TCP、UDP等传输控制协议都是建立在IP协议之上的，实际底层的数据传输还是通过IP协议的`IP数据报格式`进行传输的。  

IP协议是不可靠的协议，它不能够保证传输的数据到达目的地，当路由器的缓冲区满了之后，它会丢弃数据报。所以TCP/IP协议簇的可靠性是由TCP协议来保证的。  

IP协议是无连接的，就是说IP协议不会去维护每次传输的后续数据报的状态，即每一次数据报的传输都是独立的。TCP会报一段请求报文切割成多段报文，然后每段通过IP协议传输，其顺序和可靠性是由TCP协议实现的。  

# TCP协议
TCP是一种面向链接的，可靠的，基于字节流的通讯控制协议。  

- 面向链接：即建立全双工通讯，链接时会占用两端的通讯通道。
- 可靠性：会对报文状态进行跟踪，通过检测、超时、重传等手段保证可靠性。
- 字节流：最小传输单位为字节。

## TCP状态机

状态位 | 作用
:---:|:---:
ACK | 表示数据报已被接收方接收。
SYN | 表示同步信号，常用来建立链接，和ACK搭配使用。比如建立连接时，SYN=1，ACK=0；当建立链接的请求被响应时，SYN=1，ACK=1。
FIN | 表示发送端完成发送任务了。


## TCP链接的建立/断开
TCP通讯是面向链接的通讯，所以通讯的第一步自然是建立链接，如果通讯中途任意一方不想继续通讯了，都可以断开链接。  

### 3次握手建立链接

![image](http://ogemdlrap.bkt.clouddn.com/2964446-aa923712d5218eeb.png)  


1. c->s，SYN=1，并随机产生一个seq=j发送到s，随后c进入SYN_SEND状态，等待s响应。
2. s->c，s收到c发送来的SYN=1，seq=j消息后，知道c要链接它，然后发送SYN=1，ACK=1，将ack=j+1，并随机产生一个seq=k，一起发送给c。s进入SYN_RECV状态。
3. c->s，c收到s的响应后，检查ACK是否为1，ack是否为j+1，成立表示服务端能够正常建立链接，然后发送ACK=1，ack=k+1给s。随后链接就建立了，就可以开始通讯了。


### 4次挥手断开链接
![image](http://ogemdlrap.bkt.clouddn.com/2964446-2b9562b3a8b72fb2.png)

以客户端发起断开链接的请求为例：
1. c->s，当c没有消息要发送了，发送一个FIN=M给s，进入`FIN_WAIT_1`的等待状态。
2. s->c，当s收到c的FIN=M后，需要发送一个确认收到的消息给c，会发送ACK=1，ack=M+1。c收到这个消息后会进入`FIN_WAIYT_2`的等待状态，s则进入`CLOSE_WAIT`状态，准备关闭。
3. s->c，s接着发送一个FIN=K到c，用来告知c要关闭链接了，s进入`LATS_ACK`状态。c收到消息后进入`TIME_WAIT`状态。
4. c->s，c发送一个AKC=1，ack=K+1告知s收到关闭通知了。s收到消息后进入CLOSED状态，关闭链接。c等待一段时间，没有收到新的消息也关闭链接。


# 其它
## Socket通讯和TCP协议是什么关系？
Socket通讯是对TCP／UDP通讯协议的抽象，也就是它提供了标准操作了使用TCP协议或者UDP协议。这就是为什么基于TCP协议的HTTP协议在使用时需要先建立Socket链接。  

## TCP和UDP的区别？
TCP是面向链接的、可靠的、基于字节流的通讯。是一种需要链接的全双工通讯协议。通讯时，每发送一段报文都需要对方的确认，以保证发送成功。  

UDP是没有链接概念的，不可靠的通讯协议。UDP发送报文时只管发送，不需要对方的确认。由于不需要建立链接，只管发送，所以UDP传输效率更高。